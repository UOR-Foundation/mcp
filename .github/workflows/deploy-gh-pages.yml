name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4

      - name: Setup Node.js ðŸ”§
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies ðŸ“¦
        run: npm ci

      - name: Build ðŸ—ï¸
        run: |
          npm run build
          mkdir -p dist/public
          cp -r public/* dist/public/
          # Create .nojekyll file to prevent GitHub Pages from ignoring files that begin with an underscore
          touch dist/public/.nojekyll
          
          # Set up deployment config for GitHub Pages
          cat > dist/public/deployment-config.js << EOF
          // Deployment-specific configuration for UOR MCP Server
          window.DEPLOYMENT_CONFIG = {
            githubUser: "${{ github.repository_owner }}",
            deployedAt: "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          };

          // Apply the deployment configuration
          document.addEventListener('DOMContentLoaded', () => {
            const config = window.MCPConfig.getConfig();
            // Configuration is done through URL parameters
            window.MCPConfig.saveConfig(config);
          });
          EOF

          # Create a custom 404 page that redirects to index.html
          cat > dist/public/404.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <script>
              // Redirect to the home page with the path as a query parameter
              const path = window.location.pathname;
              window.location.href = '/?path=' + encodeURIComponent(path);
            </script>
          </head>
          <body>
            <p>Redirecting...</p>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4.4.3
        with:
          branch: gh-pages
          folder: dist/public
          clean: true